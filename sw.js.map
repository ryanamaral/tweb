{"version":3,"sources":["webpack:///webpack/bootstrap","webpack:///./src/helpers/userAgent.ts","webpack:///./src/config/debug.ts","webpack:///./src/config/modes.ts","webpack:///./src/lib/logger.ts","webpack:///./src/helpers/context.ts","webpack:///./src/lib/mtproto/mtproto.service.ts","webpack:///./src/helpers/cancellablePromise.ts"],"names":["installedModules","__webpack_require__","moduleId","exports","module","i","l","modules","call","m","c","d","name","getter","o","Object","defineProperty","enumerable","get","r","Symbol","toStringTag","value","t","mode","__esModule","ns","create","key","bind","n","object","property","prototype","hasOwnProperty","p","s","userAgent","navigator","ctx","search","toLowerCase","indexOf","test","vendor","window","self","isSafari","platform","maxTouchPoints","MSStream","match","DEBUG","location","debug","http","ssl","multipleConnections","asServiceWorker","LogLevels","_logTimer","Date","now","dT","toFixed","isWebWorker","WorkerGlobalScope","isServiceWorker","ServiceWorkerGlobalScope","notifyServiceWorker","all","args","clients","matchAll","includeUncontrolled","type","then","listeners","length","slice","forEach","listener","postMessage","notifyWorker","noop","notifySomeone","log","prefix","level","warn","error","Log","console","info","trace","setPrefix","_prefix","logger","deferredPromises","addEventListener","e","task","data","promise","id","reject","resolve","payload","taskId","onFetch","event","url","scope","params","exec","request","range","header","chunks","split","ranges","offset","end","parseRange","headers","JSON","parse","decodeURIComponent","limitPart","size","STREAM_CHUNK_UPPER_LIMIT","STREAM_CHUNK_MIDDLE_LIMIT","respondWith","Promise","race","delay","setTimeout","Response","status","statusText","possibleResponse","mimeType","Uint8Array","buffer","responseForSafariFirstRange","limit","Math","ceil","alignLimit","alignedOffset","base","alignOffset","dcId","deferredHelper","isFulfilled","isRejected","notify","notifyAll","lastNotify","callback","undefined","addNotifyListener","push","deferred","finally","cancel","assign","deferredPromise","result","ab","bytes","byteLength","catch","err","onChangeState","onfetch","waitUntil","skipWaiting","claim","onerror","onunhandledrejection","onoffline","ononline"],"mappings":"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","file":"sw.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 0);\n","/*\n * https://github.com/morethanwords/tweb\n * Copyright (C) 2019-2021 Eduard Kuzmenko\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\n */\n\nexport const userAgent = navigator ? navigator.userAgent : null;\nexport const isApple = navigator.userAgent.search(/OS X|iPhone|iPad|iOS/i) !== -1;\nexport const isAndroid = navigator.userAgent.toLowerCase().indexOf('android') !== -1;\nexport const isChromium = /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor);\n\n/**\n * Returns true when run in WebKit derived browsers.\n * This is used as a workaround for a memory leak in Safari caused by using Transferable objects to\n * transfer data between WebWorkers and the main thread.\n * https://github.com/mapbox/mapbox-gl-js/issues/8771\n *\n * This should be removed once the underlying Safari issue is fixed.\n */\nexport const ctx = typeof(window) !== 'undefined' ? window : self;\n\n// https://stackoverflow.com/a/58065241\nexport const isAppleMobile = (/iPad|iPhone|iPod/.test(navigator.platform) ||\n  (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1)) &&\n  !ctx.MSStream;\n\nexport const isSafari = !!('safari' in ctx) || !!(userAgent && (/\\b(iPad|iPhone|iPod)\\b/.test(userAgent) || (!!userAgent.match('Safari') && !userAgent.match('Chrome'))))/*  || true */;\nexport const isFirefox = navigator.userAgent.toLowerCase().indexOf('firefox') > -1;\n\nexport const isMobileSafari = isSafari && isAppleMobile;\n\nexport const isMobile = /* screen.width && screen.width < 480 ||  */navigator.userAgent.search(/iOS|iPhone OS|Android|BlackBerry|BB10|Series ?[64]0|J2ME|MIDP|opera mini|opera mobi|mobi.+Gecko|Windows Phone/i) != -1;\n","/*\n * https://github.com/morethanwords/tweb\n * Copyright (C) 2019-2021 Eduard Kuzmenko\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\n */\n\nimport Modes from \"./modes\";\n\nexport const DEBUG = process.env.NODE_ENV !== 'production' || Modes.debug;\nconst ctx: any = typeof(window) !== 'undefined' ? window : self;\nexport const MOUNT_CLASS_TO: any = DEBUG || true/*  && false */ ? ctx : {};\nexport default DEBUG;\n\n//let m = DEBUG;\n/* if(!DEBUG) {\n  ctx.sandpitTurtle = () => {\n    //if(!m) {\n      for(let i in MOUNT_CLASS_TO) {\n        ctx[i] = MOUNT_CLASS_TO[i];\n      }\n      //m = true;\n    //}\n  \n    //DEBUG = !DEBUG;\n  };\n} */\n\n/* export const superDebug = (object: any, key: string) => {\n  var d = object[key];\n  var beforeStr = '', afterStr = '';\n  for(var r of d) {\n    beforeStr += r.before.hex + '\\n';\n    afterStr += r.after.hex + '\\n';\n  }\n\n  beforeStr = beforeStr.trim();\n  afterStr = afterStr.trim();\n  //var beforeStr = d.map(r => r.before.hex).join('\\n');\n  //var afterStr = d.map(r => r.after.hex).join('\\n');\n\n  var dada = (name: string, str: string) => {\n    var a = document.createElement('a');\n    a.target = '_blank';\n    a.download = name + '.txt';\n    a.href = URL.createObjectURL(new Blob([str], {\n      type: 'text/plain'\n    }));\n    document.body.append(a);\n    a.click();\n  };\n\n  dada(key + '_' + 'before', beforeStr);\n  dada(key + '_' + 'after', afterStr);\n}\n\nMOUNT_CLASS_TO.superDebug = superDebug; */\n","/*\n * https://github.com/morethanwords/tweb\n * Copyright (C) 2019-2021 Eduard Kuzmenko\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\n * \n * Originally from:\n * https://github.com/zhukov/webogram\n * Copyright (C) 2014 Igor Zhukov <igor.beatle@gmail.com>\n * https://github.com/zhukov/webogram/blob/master/LICENSE\n */\n\nconst Modes = {\n  test: location.search.indexOf('test=1') > 0/*  || true */,\n  debug: location.search.indexOf('debug=1') > 0,\n  http: false, //location.search.indexOf('http=1') > 0,\n  ssl: true, // location.search.indexOf('ssl=1') > 0 || location.protocol === 'https:' && location.search.indexOf('ssl=0') === -1,\n  multipleConnections: true,\n  asServiceWorker: false\n};\n\n//////////////////\n/////////////////////////////\n//////////\n\nexport default Modes;\n","/*\n * https://github.com/morethanwords/tweb\n * Copyright (C) 2019-2021 Eduard Kuzmenko\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\n */\n\nimport DEBUG from \"../config/debug\";\n\nexport enum LogLevels {\n  log = 1,\n  warn = 2,\n  error = 4,\n  debug = 8\n};\n\nconst _logTimer = Date.now();\nfunction dT() {\n  return '[' + ((Date.now() - _logTimer) / 1000).toFixed(3) + ']';\n}\n\nexport function logger(prefix: string, level = LogLevels.log | LogLevels.warn | LogLevels.error) {\n  if(!DEBUG/*  || true */) {\n    level = LogLevels.error;\n  }\n\n  //level = LogLevels.log | LogLevels.warn | LogLevels.error | LogLevels.debug\n\n  function Log(...args: any[]) {\n    return level & LogLevels.log && console.log(dT(), prefix, ...args);\n  }\n  \n  Log.warn = function(...args: any[]) {\n    return level & LogLevels.warn && console.warn(dT(), prefix, ...args);\n  };\n  \n  Log.info = function(...args: any[]) {\n    return level & LogLevels.log && console.info(dT(), prefix, ...args);\n  };\n  \n  Log.error = function(...args: any[]) {\n    return level & LogLevels.error && console.error(dT(), prefix, ...args);\n  };\n  \n  Log.trace = function(...args: any[]) {\n    return level & LogLevels.log && console.trace(dT(), prefix, ...args);\n  };\n\n  /* Log.debug = function(...args: any[]) {\n    return level & LogLevels.debug && console.log(dT(), prefix, ...args);\n  }; */\n\n  Log.debug = function(...args: any[]) {\n    return level & LogLevels.debug && console.debug(dT(), prefix, ...args);\n  };\n\n  Log.setPrefix = function(_prefix: string) {\n    prefix = '[' + _prefix + ']:';\n  };\n\n  Log.setPrefix(prefix);\n  \n  return Log;\n};","/*\n * https://github.com/morethanwords/tweb\n * Copyright (C) 2019-2021 Eduard Kuzmenko\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\n */\n\nexport const isWebWorker = typeof WorkerGlobalScope !== 'undefined' && self instanceof WorkerGlobalScope;\nexport const isServiceWorker = typeof ServiceWorkerGlobalScope !== 'undefined' && self instanceof ServiceWorkerGlobalScope;\nexport const isWorker = isWebWorker || isServiceWorker;\n\n// в SW может быть сразу две переменных TRUE, поэтому проверяю по последней\n\nconst notifyServiceWorker = (all: boolean, ...args: any[]) => {\n  (self as any as ServiceWorkerGlobalScope)\n  .clients\n  .matchAll({ includeUncontrolled: false, type: 'window' })\n  .then((listeners) => {\n    if(!listeners.length) {\n      //console.trace('no listeners?', self, listeners);\n      return;\n    }\n\n    listeners.slice(all ? 0 : -1).forEach(listener => {\n      // @ts-ignore\n      listener.postMessage(...args);\n    });\n  });\n};\n\nconst notifyWorker = (...args: any[]) => {\n  // @ts-ignore\n  (self as any as DedicatedWorkerGlobalScope).postMessage(...args);\n};\n\nconst noop = () => {};\n\nexport const notifySomeone = isServiceWorker ? notifyServiceWorker.bind(null, false) : (isWebWorker ? notifyWorker : noop);\nexport const notifyAll = isServiceWorker ? notifyServiceWorker.bind(null, true) : (isWebWorker ? notifyWorker : noop);\n","/*\n * https://github.com/morethanwords/tweb\n * Copyright (C) 2019-2021 Eduard Kuzmenko\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\n */\n\n//////////////////\n//////////////////////////\n//////////\nimport { isSafari } from '../../helpers/userAgent';\nimport { logger, LogLevels } from '../logger';\nimport type { DownloadOptions } from './apiFileManager';\nimport type { WorkerTaskTemplate } from '../../types';\nimport { notifySomeone } from '../../helpers/context';\nimport type { InputFileLocation, FileLocation, UploadFile } from '../../layer';\nimport { CancellablePromise, deferredPromise } from '../../helpers/cancellablePromise';\n\nconst log = logger('SW', LogLevels.error | LogLevels.debug | LogLevels.log | LogLevels.warn);\nconst ctx = self as any as ServiceWorkerGlobalScope;\n\nconst deferredPromises: {[taskId: number]: CancellablePromise<any>} = {};\n\n///////////////////\nctx.addEventListener('message', (e) => {\n  const task = e.data as ServiceWorkerTaskResponse;\n  const promise = deferredPromises[task.id];\n\n  if(task.error) {\n    promise.reject(task.error);\n  } else {\n    promise.resolve(task.payload);\n  }\n\n  delete deferredPromises[task.id];\n});\n//////////\n\nlet taskId = 0;\n\nexport interface ServiceWorkerTask extends WorkerTaskTemplate {\n  type: 'requestFilePart',\n  payload: [number, InputFileLocation | FileLocation, number, number]\n};\n\nexport interface ServiceWorkerTaskResponse extends WorkerTaskTemplate {\n  type: 'requestFilePart',\n  payload?: UploadFile.uploadFile,\n  originalPayload?: ServiceWorkerTask['payload']\n};\n\nconst onFetch = (event: FetchEvent): void => {\n  try {\n    const [, url, scope, params] = /http[:s]+\\/\\/.*?(\\/(.*?)(?:$|\\/(.*)$))/.exec(event.request.url) || [];\n\n    log.debug('[fetch]:', event);\n  \n    switch(scope) {\n      case 'stream': {\n        const range = parseRange(event.request.headers.get('Range'));\n        let [offset, end] = range;\n  \n        const info: DownloadOptions = JSON.parse(decodeURIComponent(params));\n        //const fileName = getFileNameByLocation(info.location);\n\n        // ! если грузить очень большое видео чанками по 512Кб в мобильном Safari, то стрим не запустится\n        const limitPart = info.size > (75 * 1024 * 1024) ? STREAM_CHUNK_UPPER_LIMIT : STREAM_CHUNK_MIDDLE_LIMIT;\n\n        /* if(info.size > limitPart && isSafari && offset === limitPart) {\n          //end = info.size - 1;\n          //offset = info.size - 1 - limitPart;\n          offset = info.size - (info.size % limitPart);\n        } */\n  \n        log.debug('[stream]', url, offset, end);\n  \n        event.respondWith(Promise.race([\n          timeout(45 * 1000),\n\n          new Promise<Response>((resolve, reject) => {\n            // safari workaround\n            const possibleResponse = responseForSafariFirstRange(range, info.mimeType, info.size);\n            if(possibleResponse) {\n              return resolve(possibleResponse);\n            }\n  \n            const limit = end && end < limitPart ? alignLimit(end - offset + 1) : limitPart;\n            const alignedOffset = alignOffset(offset, limit);\n  \n            log.debug('[stream] requestFilePart:', /* info.dcId, info.location, */ alignedOffset, limit);\n\n            const task: ServiceWorkerTask = {\n              type: 'requestFilePart',\n              id: taskId++,\n              payload: [info.dcId, info.location, alignedOffset, limit]\n            };\n\n            \n            const deferred = deferredPromises[task.id] = deferredPromise<UploadFile.uploadFile>();\n            deferred.then(result => {\n              let ab = result.bytes as Uint8Array;\n              \n              log.debug('[stream] requestFilePart result:', result);\n  \n              const headers: Record<string, string> = {\n                'Accept-Ranges': 'bytes',\n                'Content-Range': `bytes ${alignedOffset}-${alignedOffset + ab.byteLength - 1}/${info.size || '*'}`,\n                'Content-Length': `${ab.byteLength}`,\n              };\n  \n              if(info.mimeType) headers['Content-Type'] = info.mimeType;\n  \n              if(isSafari) {\n                ab = ab.slice(offset - alignedOffset, end - alignedOffset + 1);\n                headers['Content-Range'] = `bytes ${offset}-${offset + ab.byteLength - 1}/${info.size || '*'}`;\n                headers['Content-Length'] = `${ab.byteLength}`;\n              }\n\n              // simulate slow connection\n              //setTimeout(() => {\n                resolve(new Response(ab, {\n                  status: 206,\n                  statusText: 'Partial Content',\n                  headers,\n                }));\n              //}, 2.5e3);\n            }).catch(err => {});\n\n            notifySomeone(task);\n          })\n        ]));\n        break;\n      }\n    }\n  } catch(err) {\n    event.respondWith(new Response('', {\n      status: 500,\n      statusText: 'Internal Server Error',\n    }));\n  }\n};\n\nconst onChangeState = () => {\n  ctx.onfetch = onFetch;\n};\n\nctx.addEventListener('install', (event) => {\n  log('installing');\n\n  /* initCache();\n\n  event.waitUntil(\n    initNetwork(),\n  ); */\n  event.waitUntil(ctx.skipWaiting()); // Activate worker immediately\n});\n\nctx.addEventListener('activate', (event) => {\n  log('activating', ctx);\n\n  /* if (!ctx.cache) initCache();\n  if (!ctx.network) initNetwork(); */\n\n  event.waitUntil(ctx.clients.claim());\n});\n\nfunction timeout(delay: number): Promise<Response> {\n  return new Promise(((resolve) => {\n    setTimeout(() => {\n      resolve(new Response('', {\n        status: 408,\n        statusText: 'Request timed out.',\n      }));\n    }, delay);\n  }));\n}\n\nfunction responseForSafariFirstRange(range: [number, number], mimeType: string, size: number): Response {\n  if(range[0] === 0 && range[1] === 1) {\n    return new Response(new Uint8Array(2).buffer, {\n      status: 206,\n      statusText: 'Partial Content',\n      headers: {\n        'Accept-Ranges': 'bytes',\n        'Content-Range': `bytes 0-1/${size || '*'}`,\n        'Content-Length': '2',\n        'Content-Type': mimeType || 'video/mp4',\n      },\n    });\n  }\n\n  return null;\n}\n\nctx.onerror = (error) => {\n  log.error('error:', error);\n};\n\nctx.onunhandledrejection = (error) => {\n  log.error('onunhandledrejection:', error);\n};\n\nctx.onoffline = ctx.ononline = onChangeState;\n\nonChangeState();\n\n/* const STREAM_CHUNK_UPPER_LIMIT = 256 * 1024;\nconst SMALLEST_CHUNK_LIMIT = 256 * 4; */\n/* const STREAM_CHUNK_UPPER_LIMIT = 1024 * 1024;\nconst SMALLEST_CHUNK_LIMIT = 1024 * 4; */\nconst STREAM_CHUNK_MIDDLE_LIMIT = 512 * 1024;\nconst STREAM_CHUNK_UPPER_LIMIT = 1024 * 1024;\nconst SMALLEST_CHUNK_LIMIT = 512 * 4;\n\nfunction parseRange(header: string): [number, number] {\n  if(!header) return [0, 0];\n  const [, chunks] = header.split('=');\n  const ranges = chunks.split(', ');\n  const [offset, end] = ranges[0].split('-');\n\n  return [+offset, +end || 0];\n}\n\nfunction alignOffset(offset: number, base = SMALLEST_CHUNK_LIMIT) {\n  return offset - (offset % base);\n}\n\nfunction alignLimit(limit: number) {\n  return 2 ** Math.ceil(Math.log(limit) / Math.log(2));\n}\n\n/* ctx.addEventListener('push', (event) => {\n  console.log('[Service Worker] Push Received.');\n  console.log(`[Service Worker] Push had this data: \"${event.data.text()}\"`, event, event.data);\n\n  const title = 'Push Push Push';\n  const options = {};\n  // const options = {\n  //   body: 'Yay it works.',\n  //   icon: 'images/icon.png',\n  //   badge: 'images/badge.png'\n  // };\n\n  event.waitUntil(ctx.registration.showNotification(title, options));\n}); */\n\n//export default () => {};\n\n//MOUNT_CLASS_TO.onFetch = onFetch;\n","/*\n * https://github.com/morethanwords/tweb\n * Copyright (C) 2019-2021 Eduard Kuzmenko\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\n */\n\nexport interface CancellablePromise<T> extends Promise<T> {\n  resolve?: (...args: any[]) => void,\n  reject?: (...args: any[]) => void,\n  cancel?: () => void,\n\n  notify?: (...args: any[]) => void,\n  notifyAll?: (...args: any[]) => void,\n  lastNotify?: any,\n  listeners?: Array<(...args: any[]) => void>,\n  addNotifyListener?: (callback: (...args: any[]) => void) => void,\n\n  isFulfilled?: boolean,\n  isRejected?: boolean\n}\n\nexport function deferredPromise<T>() {\n  let deferredHelper: any = {\n    isFulfilled: false, \n    isRejected: false,\n\n    notify: () => {}, \n    notifyAll: (...args: any[]) => {\n      deferredHelper.lastNotify = args;\n      deferredHelper.listeners.forEach((callback: any) => callback(...args));\n    }, \n\n    lastNotify: undefined,\n    listeners: [],\n    addNotifyListener: (callback: (...args: any[]) => void) => {\n      if(deferredHelper.lastNotify) {\n        callback(...deferredHelper.lastNotify);\n      }\n\n      deferredHelper.listeners.push(callback);\n    }\n  };\n\n  let deferred: CancellablePromise<T> = new Promise<T>((resolve, reject) => {\n    deferredHelper.resolve = (value: T) => {\n      if(deferred.isFulfilled) return;\n\n      deferred.isFulfilled = true;\n      resolve(value);\n    };\n    \n    deferredHelper.reject = (...args: any[]) => {\n      if(deferred.isRejected) return;\n      \n      deferred.isRejected = true;\n      reject(...args);\n    };\n  });\n\n  // @ts-ignore\n  /* deferred.then = (resolve: (value: T) => any, reject: (...args: any[]) => any) => {\n    const n = deferredPromise<ReturnType<typeof resolve>>();\n    \n  }; */\n\n  deferred.finally(() => {\n    deferred.notify = null;\n    deferred.listeners.length = 0;\n    deferred.lastNotify = null;\n\n    if(deferred.cancel) {\n      deferred.cancel = () => {};\n    }\n  });\n\n  Object.assign(deferred, deferredHelper);\n\n  return deferred;\n}"],"sourceRoot":""}