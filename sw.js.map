{"version":3,"sources":["webpack:///webpack/bootstrap","webpack:///./src/helpers/userAgent.ts","webpack:///./src/config/debug.ts","webpack:///./src/config/modes.ts","webpack:///./src/lib/logger.ts","webpack:///./src/helpers/context.ts","webpack:///./src/lib/mtproto/mtproto.service.ts","webpack:///./src/helpers/cancellablePromise.ts"],"names":["installedModules","__webpack_require__","moduleId","exports","module","i","l","modules","call","m","c","d","name","getter","o","Object","defineProperty","enumerable","get","r","Symbol","toStringTag","value","t","mode","__esModule","ns","create","key","bind","n","object","property","prototype","hasOwnProperty","p","s","userAgent","navigator","ctx","search","toLowerCase","indexOf","test","vendor","window","self","isSafari","platform","maxTouchPoints","MSStream","match","DEBUG","location","debug","http","ssl","multipleConnections","asServiceWorker","LogTypes","LOG_LEVELS","None","Error","Warn","Log","Debug","_logTimer","Date","now","dT","toFixed","isWebWorker","WorkerGlobalScope","isServiceWorker","ServiceWorkerGlobalScope","notifyServiceWorker","all","args","clients","matchAll","includeUncontrolled","type","then","listeners","length","slice","forEach","listener","postMessage","notifyWorker","noop","notifySomeone","log","prefix","console","warn","info","error","trace","setPrefix","_prefix","setLevel","level","reduce","acc","v","logger","deferredPromises","addEventListener","e","task","data","promise","id","reject","resolve","payload","taskId","onFetch","event","request","url","origin","respondWith","cache","caches","open","file","response","fetch","put","clone","err","requestCache","scope","params","exec","range","header","chunks","split","ranges","offset","end","parseRange","headers","JSON","parse","decodeURIComponent","limitPart","size","STREAM_CHUNK_UPPER_LIMIT","STREAM_CHUNK_MIDDLE_LIMIT","Promise","race","delay","setTimeout","Response","status","statusText","possibleResponse","mimeType","Uint8Array","buffer","responseForSafariFirstRange","limit","Math","ceil","alignLimit","alignedOffset","base","alignOffset","dcId","deferredHelper","isFulfilled","isRejected","notify","notifyAll","lastNotify","callback","undefined","addNotifyListener","push","deferred","finally","cancel","assign","deferredPromise","result","ab","bytes","byteLength","catch","onChangeState","onfetch","waitUntil","skipWaiting","delete","claim","onerror","onunhandledrejection","onoffline","ononline"],"mappings":"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","file":"sw.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 0);\n","/*\n * https://github.com/morethanwords/tweb\n * Copyright (C) 2019-2021 Eduard Kuzmenko\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\n */\n\nexport const userAgent = navigator ? navigator.userAgent : null;\nexport const isApple = navigator.userAgent.search(/OS X|iPhone|iPad|iOS/i) !== -1;\nexport const isAndroid = navigator.userAgent.toLowerCase().indexOf('android') !== -1;\nexport const isChromium = /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor);\n\n/**\n * Returns true when run in WebKit derived browsers.\n * This is used as a workaround for a memory leak in Safari caused by using Transferable objects to\n * transfer data between WebWorkers and the main thread.\n * https://github.com/mapbox/mapbox-gl-js/issues/8771\n *\n * This should be removed once the underlying Safari issue is fixed.\n */\nexport const ctx = typeof(window) !== 'undefined' ? window : self;\n\n// https://stackoverflow.com/a/58065241\nexport const isAppleMobile = (/iPad|iPhone|iPod/.test(navigator.platform) ||\n  (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1)) &&\n  !ctx.MSStream;\n\nexport const isSafari = !!('safari' in ctx) || !!(userAgent && (/\\b(iPad|iPhone|iPod)\\b/.test(userAgent) || (!!userAgent.match('Safari') && !userAgent.match('Chrome'))))/*  || true */;\nexport const isFirefox = navigator.userAgent.toLowerCase().indexOf('firefox') > -1;\n\nexport const isMobileSafari = isSafari && isAppleMobile;\n\nexport const isMobile = /* screen.width && screen.width < 480 ||  */navigator.userAgent.search(/iOS|iPhone OS|Android|BlackBerry|BB10|Series ?[64]0|J2ME|MIDP|opera mini|opera mobi|mobi.+Gecko|Windows Phone/i) != -1;\n","/*\n * https://github.com/morethanwords/tweb\n * Copyright (C) 2019-2021 Eduard Kuzmenko\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\n */\n\nimport Modes from \"./modes\";\n\nexport const DEBUG = process.env.NODE_ENV !== 'production' || Modes.debug;\nconst ctx: any = typeof(window) !== 'undefined' ? window : self;\nexport const MOUNT_CLASS_TO: any = DEBUG || true/*  && false */ ? ctx : {};\nexport default DEBUG;\n\n//let m = DEBUG;\n/* if(!DEBUG) {\n  ctx.sandpitTurtle = () => {\n    //if(!m) {\n      for(let i in MOUNT_CLASS_TO) {\n        ctx[i] = MOUNT_CLASS_TO[i];\n      }\n      //m = true;\n    //}\n  \n    //DEBUG = !DEBUG;\n  };\n} */\n\n/* export const superDebug = (object: any, key: string) => {\n  var d = object[key];\n  var beforeStr = '', afterStr = '';\n  for(var r of d) {\n    beforeStr += r.before.hex + '\\n';\n    afterStr += r.after.hex + '\\n';\n  }\n\n  beforeStr = beforeStr.trim();\n  afterStr = afterStr.trim();\n  //var beforeStr = d.map(r => r.before.hex).join('\\n');\n  //var afterStr = d.map(r => r.after.hex).join('\\n');\n\n  var dada = (name: string, str: string) => {\n    var a = document.createElement('a');\n    a.target = '_blank';\n    a.download = name + '.txt';\n    a.href = URL.createObjectURL(new Blob([str], {\n      type: 'text/plain'\n    }));\n    document.body.append(a);\n    a.click();\n  };\n\n  dada(key + '_' + 'before', beforeStr);\n  dada(key + '_' + 'after', afterStr);\n}\n\nMOUNT_CLASS_TO.superDebug = superDebug; */\n","/*\n * https://github.com/morethanwords/tweb\n * Copyright (C) 2019-2021 Eduard Kuzmenko\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\n * \n * Originally from:\n * https://github.com/zhukov/webogram\n * Copyright (C) 2014 Igor Zhukov <igor.beatle@gmail.com>\n * https://github.com/zhukov/webogram/blob/master/LICENSE\n */\n\nconst Modes = {\n  test: location.search.indexOf('test=1') > 0/*  || true */,\n  debug: location.search.indexOf('debug=1') > 0,\n  http: false, //location.search.indexOf('http=1') > 0,\n  ssl: true, // location.search.indexOf('ssl=1') > 0 || location.protocol === 'https:' && location.search.indexOf('ssl=0') === -1,\n  multipleConnections: true,\n  asServiceWorker: false\n};\n\n                  \n                             \n          \n\nexport default Modes;\n","/*\n * https://github.com/morethanwords/tweb\n * Copyright (C) 2019-2021 Eduard Kuzmenko\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\n */\n\nimport DEBUG from \"../config/debug\";\n\nexport enum LogTypes {\n  None = 0,\n  Error = 1,\n  Warn = 2,\n  Log = 4,\n  Debug = 8\n};\n\nexport const LOG_LEVELS = [LogTypes.None, LogTypes.Error, LogTypes.Warn, LogTypes.Log, LogTypes.Debug];\n\nconst _logTimer = Date.now();\nfunction dT() {\n  return '[' + ((Date.now() - _logTimer) / 1000).toFixed(3) + ']';\n}\n\nexport function logger(prefix: string, type: LogTypes = LogTypes.Log | LogTypes.Warn | LogTypes.Error) {\n  if(!DEBUG/*  || true */) {\n    type = LogTypes.Error;\n  }\n\n  //level = LogLevels.log | LogLevels.warn | LogLevels.error | LogLevels.debug\n\n  function Log(...args: any[]) {\n    return type & LogTypes.Log && console.log(dT(), prefix, ...args);\n  }\n  \n  Log.warn = function(...args: any[]) {\n    return type & LogTypes.Warn && console.warn(dT(), prefix, ...args);\n  };\n  \n  Log.info = function(...args: any[]) {\n    return type & LogTypes.Log && console.info(dT(), prefix, ...args);\n  };\n  \n  Log.error = function(...args: any[]) {\n    return type & LogTypes.Error && console.error(dT(), prefix, ...args);\n  };\n  \n  Log.trace = function(...args: any[]) {\n    return type & LogTypes.Log && console.trace(dT(), prefix, ...args);\n  };\n\n  /* Log.debug = function(...args: any[]) {\n    return level & LogLevels.debug && console.log(dT(), prefix, ...args);\n  }; */\n\n  Log.debug = function(...args: any[]) {\n    return type & LogTypes.Debug && console.debug(dT(), prefix, ...args);\n  };\n\n  Log.setPrefix = function(_prefix: string) {\n    prefix = '[' + _prefix + ']:';\n  };\n\n  Log.setPrefix(prefix);\n\n  Log.setLevel = function(level: 0 | 1 | 2 | 3 | 4) {\n    type = LOG_LEVELS.slice(0, level + 1).reduce((acc, v) => acc | v, 0) as any;\n  };\n  \n  return Log;\n};\n","/*\n * https://github.com/morethanwords/tweb\n * Copyright (C) 2019-2021 Eduard Kuzmenko\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\n */\n\nexport const isWebWorker = typeof WorkerGlobalScope !== 'undefined' && self instanceof WorkerGlobalScope;\nexport const isServiceWorker = typeof ServiceWorkerGlobalScope !== 'undefined' && self instanceof ServiceWorkerGlobalScope;\nexport const isWorker = isWebWorker || isServiceWorker;\n\n// в SW может быть сразу две переменных TRUE, поэтому проверяю по последней\n\nconst notifyServiceWorker = (all: boolean, ...args: any[]) => {\n  (self as any as ServiceWorkerGlobalScope)\n  .clients\n  .matchAll({ includeUncontrolled: false, type: 'window' })\n  .then((listeners) => {\n    if(!listeners.length) {\n      //console.trace('no listeners?', self, listeners);\n      return;\n    }\n\n    listeners.slice(all ? 0 : -1).forEach(listener => {\n      // @ts-ignore\n      listener.postMessage(...args);\n    });\n  });\n};\n\nconst notifyWorker = (...args: any[]) => {\n  // @ts-ignore\n  (self as any as DedicatedWorkerGlobalScope).postMessage(...args);\n};\n\nconst noop = () => {};\n\nexport const notifySomeone = isServiceWorker ? notifyServiceWorker.bind(null, false) : (isWebWorker ? notifyWorker : noop);\nexport const notifyAll = isServiceWorker ? notifyServiceWorker.bind(null, true) : (isWebWorker ? notifyWorker : noop);\n","/*\n * https://github.com/morethanwords/tweb\n * Copyright (C) 2019-2021 Eduard Kuzmenko\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\n */\n\n                  \n                          \n          \n//import CacheStorageController from '../cacheStorage';\nimport { isSafari } from '../../helpers/userAgent';\nimport { logger, LogTypes } from '../logger';\nimport type { DownloadOptions } from './apiFileManager';\nimport type { WorkerTaskTemplate } from '../../types';\nimport { notifySomeone } from '../../helpers/context';\nimport type { InputFileLocation, UploadFile } from '../../layer';\nimport { CancellablePromise, deferredPromise } from '../../helpers/cancellablePromise';\n\nconst log = logger('SW', LogTypes.Error | LogTypes.Debug | LogTypes.Log | LogTypes.Warn);\nconst ctx = self as any as ServiceWorkerGlobalScope;\n\nconst deferredPromises: {[taskId: number]: CancellablePromise<any>} = {};\n\nexport interface ServiceWorkerTask extends WorkerTaskTemplate {\n  type: 'requestFilePart',\n  payload: [number, InputFileLocation, number, number]\n};\n\nexport interface ServiceWorkerTaskResponse extends WorkerTaskTemplate {\n  type: 'requestFilePart',\n  payload?: UploadFile.uploadFile,\n  originalPayload?: ServiceWorkerTask['payload']\n};\n\n                   \nctx.addEventListener('message', (e) => {\n  const task = e.data as ServiceWorkerTaskResponse;\n  const promise = deferredPromises[task.id];\n\n  if(task.error) {\n    promise.reject(task.error);\n  } else {\n    promise.resolve(task.payload);\n  }\n\n  delete deferredPromises[task.id];\n});\n          \n\n//const cacheStorage = new CacheStorageController('cachedAssets');\nlet taskId = 0;\n\nasync function requestCache(event: FetchEvent) {\n  try {\n    const cache = await ctx.caches.open('cachedAssets');\n    const file = await cache.match(event.request);\n  \n    if(file) {\n      return file;\n    }\n  \n    const response = await fetch(event.request);\n    cache.put(event.request, response.clone());\n  \n    return response;\n  } catch(err) {\n    return fetch(event.request);\n  }\n}\n\nconst onFetch = (event: FetchEvent): void => {\n  if(event.request.url.indexOf(location.origin + '/') === 0 && event.request.url.match(/\\.(js|css|jpe?g|json|wasm|png|mp3|svg|tgs|ico|woff2?|ttf|webmanifest?)(?:\\?.*)?$/)) {\n    return event.respondWith(requestCache(event));\n  }\n\n  try {\n    const [, url, scope, params] = /http[:s]+\\/\\/.*?(\\/(.*?)(?:$|\\/(.*)$))/.exec(event.request.url) || [];\n\n    //log.debug('[fetch]:', event);\n  \n    switch(scope) {\n      case 'stream': {\n        const range = parseRange(event.request.headers.get('Range'));\n        let [offset, end] = range;\n  \n        const info: DownloadOptions = JSON.parse(decodeURIComponent(params));\n        //const fileName = getFileNameByLocation(info.location);\n\n        // ! если грузить очень большое видео чанками по 512Кб в мобильном Safari, то стрим не запустится\n        const limitPart = info.size > (75 * 1024 * 1024) ? STREAM_CHUNK_UPPER_LIMIT : STREAM_CHUNK_MIDDLE_LIMIT;\n\n        /* if(info.size > limitPart && isSafari && offset === limitPart) {\n          //end = info.size - 1;\n          //offset = info.size - 1 - limitPart;\n          offset = info.size - (info.size % limitPart);\n        } */\n  \n        //log.debug('[stream]', url, offset, end);\n  \n        event.respondWith(Promise.race([\n          timeout(45 * 1000),\n\n          new Promise<Response>((resolve, reject) => {\n            // safari workaround\n            const possibleResponse = responseForSafariFirstRange(range, info.mimeType, info.size);\n            if(possibleResponse) {\n              return resolve(possibleResponse);\n            }\n  \n            const limit = end && end < limitPart ? alignLimit(end - offset + 1) : limitPart;\n            const alignedOffset = alignOffset(offset, limit);\n  \n            //log.debug('[stream] requestFilePart:', /* info.dcId, info.location, */ alignedOffset, limit);\n\n            const task: ServiceWorkerTask = {\n              type: 'requestFilePart',\n              id: taskId++,\n              payload: [info.dcId, info.location, alignedOffset, limit]\n            };\n\n            \n            const deferred = deferredPromises[task.id] = deferredPromise<UploadFile.uploadFile>();\n            deferred.then(result => {\n              let ab = result.bytes as Uint8Array;\n              \n              //log.debug('[stream] requestFilePart result:', result);\n  \n              const headers: Record<string, string> = {\n                'Accept-Ranges': 'bytes',\n                'Content-Range': `bytes ${alignedOffset}-${alignedOffset + ab.byteLength - 1}/${info.size || '*'}`,\n                'Content-Length': `${ab.byteLength}`,\n              };\n  \n              if(info.mimeType) headers['Content-Type'] = info.mimeType;\n  \n              if(isSafari) {\n                ab = ab.slice(offset - alignedOffset, end - alignedOffset + 1);\n                headers['Content-Range'] = `bytes ${offset}-${offset + ab.byteLength - 1}/${info.size || '*'}`;\n                headers['Content-Length'] = `${ab.byteLength}`;\n              }\n\n              // simulate slow connection\n              //setTimeout(() => {\n                resolve(new Response(ab, {\n                  status: 206,\n                  statusText: 'Partial Content',\n                  headers,\n                }));\n              //}, 2.5e3);\n            }).catch(err => {});\n\n            notifySomeone(task);\n          })\n        ]));\n        break;\n      }\n    }\n  } catch(err) {\n    event.respondWith(new Response('', {\n      status: 500,\n      statusText: 'Internal Server Error',\n    }));\n  }\n};\n\nconst onChangeState = () => {\n  ctx.onfetch = onFetch;\n};\n\nctx.addEventListener('install', (event) => {\n  log('installing');\n\n  /* initCache();\n\n  event.waitUntil(\n    initNetwork(),\n  ); */\n  event.waitUntil(ctx.skipWaiting()); // Activate worker immediately\n});\n\nctx.addEventListener('activate', (event) => {\n  log('activating', ctx);\n\n  /* if (!ctx.cache) initCache();\n  if (!ctx.network) initNetwork(); */\n\n  event.waitUntil(ctx.caches.delete('cachedAssets'));\n  event.waitUntil(ctx.clients.claim());\n});\n\nfunction timeout(delay: number): Promise<Response> {\n  return new Promise(((resolve) => {\n    setTimeout(() => {\n      resolve(new Response('', {\n        status: 408,\n        statusText: 'Request timed out.',\n      }));\n    }, delay);\n  }));\n}\n\nfunction responseForSafariFirstRange(range: [number, number], mimeType: string, size: number): Response {\n  if(range[0] === 0 && range[1] === 1) {\n    return new Response(new Uint8Array(2).buffer, {\n      status: 206,\n      statusText: 'Partial Content',\n      headers: {\n        'Accept-Ranges': 'bytes',\n        'Content-Range': `bytes 0-1/${size || '*'}`,\n        'Content-Length': '2',\n        'Content-Type': mimeType || 'video/mp4',\n      },\n    });\n  }\n\n  return null;\n}\n\nctx.onerror = (error) => {\n  log.error('error:', error);\n};\n\nctx.onunhandledrejection = (error) => {\n  log.error('onunhandledrejection:', error);\n};\n\nctx.onoffline = ctx.ononline = onChangeState;\n\nonChangeState();\n\n/* const STREAM_CHUNK_UPPER_LIMIT = 256 * 1024;\nconst SMALLEST_CHUNK_LIMIT = 256 * 4; */\n/* const STREAM_CHUNK_UPPER_LIMIT = 1024 * 1024;\nconst SMALLEST_CHUNK_LIMIT = 1024 * 4; */\nconst STREAM_CHUNK_MIDDLE_LIMIT = 512 * 1024;\nconst STREAM_CHUNK_UPPER_LIMIT = 1024 * 1024;\nconst SMALLEST_CHUNK_LIMIT = 512 * 4;\n\nfunction parseRange(header: string): [number, number] {\n  if(!header) return [0, 0];\n  const [, chunks] = header.split('=');\n  const ranges = chunks.split(', ');\n  const [offset, end] = ranges[0].split('-');\n\n  return [+offset, +end || 0];\n}\n\nfunction alignOffset(offset: number, base = SMALLEST_CHUNK_LIMIT) {\n  return offset - (offset % base);\n}\n\nfunction alignLimit(limit: number) {\n  return 2 ** Math.ceil(Math.log(limit) / Math.log(2));\n}\n\n/* ctx.addEventListener('push', (event) => {\n  console.log('[Service Worker] Push Received.');\n  console.log(`[Service Worker] Push had this data: \"${event.data.text()}\"`, event, event.data);\n\n  const title = 'Push Push Push';\n  const options = {};\n  // const options = {\n  //   body: 'Yay it works.',\n  //   icon: 'images/icon.png',\n  //   badge: 'images/badge.png'\n  // };\n\n  event.waitUntil(ctx.registration.showNotification(title, options));\n}); */\n\n//export default () => {};\n\n//MOUNT_CLASS_TO.onFetch = onFetch;\n","/*\n * https://github.com/morethanwords/tweb\n * Copyright (C) 2019-2021 Eduard Kuzmenko\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\n */\n\nexport interface CancellablePromise<T> extends Promise<T> {\n  resolve?: (...args: any[]) => void,\n  reject?: (...args: any[]) => void,\n  cancel?: () => void,\n\n  notify?: (...args: any[]) => void,\n  notifyAll?: (...args: any[]) => void,\n  lastNotify?: any,\n  listeners?: Array<(...args: any[]) => void>,\n  addNotifyListener?: (callback: (...args: any[]) => void) => void,\n\n  isFulfilled?: boolean,\n  isRejected?: boolean\n}\n\nexport function deferredPromise<T>() {\n  let deferredHelper: any = {\n    isFulfilled: false, \n    isRejected: false,\n\n    notify: () => {}, \n    notifyAll: (...args: any[]) => {\n      deferredHelper.lastNotify = args;\n      deferredHelper.listeners.forEach((callback: any) => callback(...args));\n    }, \n\n    lastNotify: undefined,\n    listeners: [],\n    addNotifyListener: (callback: (...args: any[]) => void) => {\n      if(deferredHelper.lastNotify) {\n        callback(...deferredHelper.lastNotify);\n      }\n\n      deferredHelper.listeners.push(callback);\n    }\n  };\n\n  let deferred: CancellablePromise<T> = new Promise<T>((resolve, reject) => {\n    deferredHelper.resolve = (value: T) => {\n      if(deferred.isFulfilled) return;\n\n      deferred.isFulfilled = true;\n      resolve(value);\n    };\n    \n    deferredHelper.reject = (...args: any[]) => {\n      if(deferred.isRejected) return;\n      \n      deferred.isRejected = true;\n      reject(...args);\n    };\n  });\n\n  // @ts-ignore\n  /* deferred.then = (resolve: (value: T) => any, reject: (...args: any[]) => any) => {\n    const n = deferredPromise<ReturnType<typeof resolve>>();\n    \n  }; */\n\n  deferred.finally(() => {\n    deferred.notify = null;\n    deferred.listeners.length = 0;\n    deferred.lastNotify = null;\n\n    if(deferred.cancel) {\n      deferred.cancel = () => {};\n    }\n  });\n\n  Object.assign(deferred, deferredHelper);\n\n  return deferred;\n}"],"sourceRoot":""}